{% extends "base.html" %}

{% block title %}Port Management - Rogue Detection System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-network-wired"></i> Port Management</h2>
        <hr>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <button class="btn btn-primary" id="refreshBtn" onclick="refreshPorts()">
                    <i class="fas fa-sync" id="refreshIcon"></i> Refresh Port Status
                </button>
                <span class="ms-3 text-muted" id="lastRefresh">Last refreshed: Never</span>
            </div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()">
                <label class="form-check-label" for="autoRefreshToggle">
                    Auto-refresh (30s)
                </label>
            </div>
        </div>
    </div>
</div>

<!-- Port Status Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Switch Ports Status</h5>
                    <div class="input-group" style="width: 300px;">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="portSearch" placeholder="Search ports..." onkeyup="filterPorts()">
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Port Statistics -->
                <div class="row mb-3" id="portStats" style="display: none;">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>Total Ports</h6>
                                <h3 id="totalPorts">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h6>Connected</h6>
                                <h3 id="connectedPorts">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center">
                                <h6>Disabled</h6>
                                <h3 id="disabledPorts">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-secondary text-white">
                            <div class="card-body text-center">
                                <h6>Not Connected</h6>
                                <h3 id="notConnectedPorts">0</h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover" id="portsTable">
                        <thead>
                            <tr>
                                <th>Port</th>
                                <th>Admin Status</th>
                                <th>Operational Status</th>
                                <th>VLAN</th>
                                <th>Last Modified</th>
                                <th>Modified By</th>
                                <th>Reason</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ports-tbody">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <i class="fas fa-spinner fa-spin"></i> Loading ports...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Port Action Modal -->
<div class="modal fade" id="portActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="portActionTitle">Port Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="actionPort">
                <input type="hidden" id="actionType">
                
                <div class="mb-3">
                    <label for="actionReason" class="form-label">Reason:</label>
                    <textarea class="form-control" id="actionReason" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="executePortAction()">Execute</button>
            </div>
        </div>
    </div>
</div>

<!-- Change VLAN Modal -->
<div class="modal fade" id="changeVLANModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-network-wired"></i> Change Port VLAN</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="vlanChangePort">
                
                <div class="mb-3">
                    <label class="form-label"><strong>Port:</strong> <span id="vlanChangePortName"></span></label>
                </div>
                
                <div class="mb-3">
                    <label class="form-label"><strong>Current VLAN:</strong> <span id="vlanChangeCurrent" class="badge bg-info"></span></label>
                </div>
                
                <div class="mb-3">
                    <label for="vlanChangeNew" class="form-label">New VLAN ID:</label>
                    <select class="form-select" id="vlanChangeNew">
                        <option value="1">VLAN 1 (Default)</option>
                        <option value="5">VLAN 5</option>
                        <option value="10">VLAN 10</option>
                        <option value="20">VLAN 20</option>
                        <option value="30">VLAN 30</option>
                        <option value="99">VLAN 99</option>
                        <option value="999">VLAN 999 (Quarantine)</option>
                        <option value="custom">Custom VLAN...</option>
                    </select>
                </div>
                
                <div class="mb-3" id="customVLANInput" style="display: none;">
                    <label for="vlanChangeCustom" class="form-label">Custom VLAN ID (1-4094):</label>
                    <input type="number" class="form-control" id="vlanChangeCustom" min="1" max="4094" placeholder="Enter VLAN ID">
                </div>
                
                <div class="mb-3">
                    <label for="vlanChangeReason" class="form-label">Reason (optional):</label>
                    <textarea class="form-control" id="vlanChangeReason" rows="2" placeholder="Why are you changing this VLAN?"></textarea>
                </div>
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Warning:</strong> Changing the VLAN will affect network connectivity for devices on this port.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="executeVLANChange()">
                    <i class="fas fa-network-wired"></i> Change VLAN
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Force cache refresh by adding timestamp
console.log('Ports page loaded at:', new Date().toISOString());
let portActionModal;
let autoRefreshInterval = null;
let isRefreshing = false;

let changeVLANModal;

document.addEventListener('DOMContentLoaded', function() {
    portActionModal = new bootstrap.Modal(document.getElementById('portActionModal'));
    changeVLANModal = new bootstrap.Modal(document.getElementById('changeVLANModal'));
    refreshPorts();
    
    // Restore auto-refresh setting from localStorage
    const autoRefreshEnabled = localStorage.getItem('autoRefreshPorts') === 'true';
    if (autoRefreshEnabled) {
        document.getElementById('autoRefreshToggle').checked = true;
        startAutoRefresh();
    }
    
    // Handle custom VLAN input toggle
    document.getElementById('vlanChangeNew').addEventListener('change', function() {
        const customInput = document.getElementById('customVLANInput');
        if (this.value === 'custom') {
            customInput.style.display = 'block';
        } else {
            customInput.style.display = 'none';
        }
    });
});

function refreshPorts(silent = false) {
    // Prevent multiple simultaneous refreshes
    if (isRefreshing) {
        console.log('Refresh already in progress, skipping...');
        return;
    }
    
    isRefreshing = true;
    const refreshBtn = document.getElementById('refreshBtn');
    const refreshIcon = document.getElementById('refreshIcon');
    
    // Show loading state
    refreshBtn.disabled = true;
    refreshIcon.classList.add('fa-spin');
    
    // Add timestamp to prevent caching
    const timestamp = new Date().getTime();
    
    fetch(`/api/ports/status?_=${timestamp}`)
        .then(response => {
            // Check if response is actually JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Server returned non-JSON response. Please refresh the page and login again.');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                displayPorts(data.ports, data.database_ports);
                updateLastRefreshTime();
                
                // Only show success message if not silent refresh
                if (!silent) {
                    showMessage('success', `Refreshed successfully! Found ${data.ports.length} ports`);
                }
            } else {
                showMessage('danger', data.message || 'Failed to load ports');
            }
        })
        .catch(error => {
            console.error('Port refresh error:', error);
            showMessage('danger', 'Error refreshing ports: ' + error.message);
        })
        .finally(() => {
            // Remove loading state
            refreshBtn.disabled = false;
            refreshIcon.classList.remove('fa-spin');
            isRefreshing = false;
        });
}

function updateLastRefreshTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    document.getElementById('lastRefresh').textContent = `Last refreshed: ${timeString}`;
}

function toggleAutoRefresh() {
    const isEnabled = document.getElementById('autoRefreshToggle').checked;
    localStorage.setItem('autoRefreshPorts', isEnabled);
    
    if (isEnabled) {
        startAutoRefresh();
        showMessage('info', 'Auto-refresh enabled (every 30 seconds)');
    } else {
        stopAutoRefresh();
        showMessage('info', 'Auto-refresh disabled');
    }
}

function startAutoRefresh() {
    // Clear any existing interval
    stopAutoRefresh();
    
    // Set new interval (30 seconds)
    autoRefreshInterval = setInterval(() => {
        console.log('Auto-refreshing ports...');
        refreshPorts();
    }, 30000);
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// Clean up interval when page is unloaded
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});

function displayPorts(switchPorts, dbPorts) {
    const tbody = document.getElementById('ports-tbody');
    
    if (!switchPorts || switchPorts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No ports found</td></tr>';
        document.getElementById('portStats').style.display = 'none';
        return;
    }
    
    // Calculate statistics
    let connectedCount = 0;
    let disabledCount = 0;
    let notConnectedCount = 0;
    
    switchPorts.forEach(port => {
        const status = (port.status || 'unknown').toLowerCase();
        if (status === 'connected') connectedCount++;
        else if (status === 'disabled') disabledCount++;
        else if (status === 'notconnect' || status === 'notconnected') notConnectedCount++;
    });
    
    // Update statistics
    document.getElementById('totalPorts').textContent = switchPorts.length;
    document.getElementById('connectedPorts').textContent = connectedCount;
    document.getElementById('disabledPorts').textContent = disabledCount;
    document.getElementById('notConnectedPorts').textContent = notConnectedCount;
    document.getElementById('portStats').style.display = 'flex';
    
    // Create lookup for database ports
    const dbPortsMap = {};
    if (dbPorts) {
        dbPorts.forEach(port => {
            dbPortsMap[port.port_name] = port;
        });
    }
    
    tbody.innerHTML = switchPorts.map(port => {
        const dbInfo = dbPortsMap[port.port] || {};
        const adminStatus = port.status || 'unknown';
        
        // Determine status badge color
        const statusColor = adminStatus === 'connected' ? 'success' : 
                           adminStatus === 'disabled' ? 'danger' : 
                           adminStatus === 'notconnect' ? 'secondary' : 'warning';
        
        // Operational status - same as admin status for now (connected = up, notconnect = down, disabled = down)
        const operStatus = adminStatus === 'connected' ? 'up' : 
                          adminStatus === 'disabled' ? 'down' : 
                          adminStatus === 'notconnect' ? 'down' : 'unknown';
        const operColor = operStatus === 'up' ? 'success' : 'secondary';
        
        return `
            <tr class="port-row" data-port-name="${port.port.toLowerCase()}" data-status="${adminStatus.toLowerCase()}" data-vlan="${port.vlan || 'N/A'}">
                <td><strong>${port.port}</strong></td>
                <td><span class="badge bg-${statusColor}">${adminStatus}</span></td>
                <td><span class="badge bg-${operColor}">${operStatus}</span></td>
                <td><span class="badge bg-info">${port.vlan || 'N/A'}</span></td>
                <td>${dbInfo.last_modified ? new Date(dbInfo.last_modified).toLocaleString() : 'N/A'}</td>
                <td>${dbInfo.modified_by || 'N/A'}</td>
                <td>${dbInfo.reason || 'N/A'}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-warning" onclick="changePortVLAN('${port.port}', ${port.vlan || 1})" title="Change VLAN">
                            <i class="fas fa-network-wired"></i>
                        </button>
                        <button class="btn btn-danger" onclick="shutdownPort('${port.port}')" title="Shutdown port">
                            <i class="fas fa-stop"></i>
                        </button>
                        <button class="btn btn-success" onclick="enablePort('${port.port}')" title="Enable port">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="btn btn-info" onclick="getPortStatus('${port.port}')" title="Get status">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function filterPorts() {
    const searchValue = document.getElementById('portSearch').value.toLowerCase();
    const rows = document.querySelectorAll('.port-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const portName = row.getAttribute('data-port-name');
        const status = row.getAttribute('data-status');
        const vlan = row.getAttribute('data-vlan');
        
        if (portName.includes(searchValue) || 
            status.includes(searchValue) || 
            vlan.includes(searchValue)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Show message if no results
    const tbody = document.getElementById('ports-tbody');
    if (visibleCount === 0 && rows.length > 0) {
        const noResultsRow = document.createElement('tr');
        noResultsRow.innerHTML = '<td colspan="8" class="text-center text-muted">No ports match your search</td>';
        noResultsRow.id = 'noResultsRow';
        tbody.appendChild(noResultsRow);
    } else {
        // Remove "no results" row if it exists
        const noResultsRow = document.getElementById('noResultsRow');
        if (noResultsRow) {
            noResultsRow.remove();
        }
    }
}

function shutdownPort(port) {
    document.getElementById('actionPort').value = port;
    document.getElementById('actionType').value = 'shutdown';
    document.getElementById('portActionTitle').textContent = `Shutdown Port ${port}`;
    document.getElementById('actionReason').value = 'Manual shutdown';
    portActionModal.show();
}

function enablePort(port) {
    document.getElementById('actionPort').value = port;
    document.getElementById('actionType').value = 'enable';
    document.getElementById('portActionTitle').textContent = `Enable Port ${port}`;
    document.getElementById('actionReason').value = 'Manual enable';
    portActionModal.show();
}

function executePortAction() {
    const port = document.getElementById('actionPort').value;
    const action = document.getElementById('actionType').value;
    const reason = document.getElementById('actionReason').value;
    
    // Use port name directly - Flask <path:port_name> handles slashes
    const url = `/api/ports/${port}/${action}`;
    
    // Show loading state
    const executeBtn = event.target || document.querySelector('#portActionModal .btn-primary');
    const originalText = executeBtn.innerHTML;
    executeBtn.disabled = true;
    executeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    
    fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason: reason })
    })
    .then(response => {
        // Check if response is actually JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server returned non-JSON response. Please refresh the page and login again.');
        }
        return response.json();
    })
    .then(data => {
        executeBtn.innerHTML = originalText;
        executeBtn.disabled = false;
        portActionModal.hide();
        
        if (data.success) {
            showMessage('success', data.message + ' - Refreshing port status...');
            
            // Update the specific port row immediately for instant feedback
            updatePortRowStatus(port, action);
            
            // Refresh all ports after a short delay to get actual switch status (silent refresh)
            setTimeout(() => {
                refreshPorts(true); // Silent refresh - no success message
            }, 1500);
        } else {
            showMessage('danger', data.message);
        }
    })
    .catch(error => {
        console.error('Port action error:', error);
        executeBtn.innerHTML = originalText;
        executeBtn.disabled = false;
        portActionModal.hide();
        showMessage('danger', 'Error: ' + error.message);
    });
}

function updatePortRowStatus(port, action) {
    // Immediately update the UI to provide instant feedback
    const rows = document.querySelectorAll('.port-row');
    rows.forEach(row => {
        const portName = row.querySelector('td strong')?.textContent;
        if (portName === port) {
            const statusCell = row.querySelectorAll('td')[1]; // Admin Status column
            const badge = statusCell.querySelector('.badge');
            
            if (action === 'shutdown') {
                // Update to disabled state
                badge.className = 'badge bg-danger';
                badge.textContent = 'disabled';
                row.setAttribute('data-status', 'disabled');
            } else if (action === 'enable') {
                // Update to connected state (will be verified on refresh)
                badge.className = 'badge bg-success';
                badge.textContent = 'connected';
                row.setAttribute('data-status', 'connected');
            }
            
            // Add a visual indicator that this is pending verification
            badge.innerHTML += ' <i class="fas fa-spinner fa-spin fa-xs"></i>';
        }
    });
}

function getPortStatus(port) {
    // Use port name directly - Flask <path:port_name> handles slashes
    fetch(`/api/ports/${port}/status`)
        .then(response => {
            // Check if response is actually JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Server returned non-JSON response. Please refresh the page and login again.');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const status = data.switch_status;
                const dbStatus = data.database_status;
                
                let message = `Port: ${port}\n\n`;
                message += `Switch Information:\n`;
                message += `Admin Status: ${status.admin_status}\n`;
                message += `Operational Status: ${status.operational_status}\n`;
                message += `Speed: ${status.speed}\n`;
                message += `Duplex: ${status.duplex}\n`;
                
                if (dbStatus) {
                    message += `\nDatabase Information:\n`;
                    message += `Last Modified: ${new Date(dbStatus.last_modified).toLocaleString()}\n`;
                    message += `Modified By: ${dbStatus.modified_by}\n`;
                    message += `Reason: ${dbStatus.reason || 'N/A'}`;
                }
                
                alert(message);
            } else {
                showMessage('danger', data.message || 'Could not retrieve port status');
            }
        })
        .catch(error => {
            console.error('Get port status error:', error);
            showMessage('danger', 'Error: ' + error.message);
        });
}

function changePortVLAN(port, currentVLAN) {
    // Open the VLAN change modal
    document.getElementById('vlanChangePort').value = port;
    document.getElementById('vlanChangePortName').textContent = port;
    document.getElementById('vlanChangeCurrent').textContent = currentVLAN;
    document.getElementById('vlanChangeNew').value = currentVLAN;
    document.getElementById('vlanChangeReason').value = '';
    document.getElementById('customVLANInput').style.display = 'none';
    document.getElementById('vlanChangeCustom').value = '';
    
    changeVLANModal.show();
}

function executeVLANChange() {
    const port = document.getElementById('vlanChangePort').value;
    const vlanSelect = document.getElementById('vlanChangeNew').value;
    let newVLAN;
    
    // Get the new VLAN ID
    if (vlanSelect === 'custom') {
        newVLAN = parseInt(document.getElementById('vlanChangeCustom').value);
        if (!newVLAN || newVLAN < 1 || newVLAN > 4094) {
            showMessage('danger', 'Please enter a valid VLAN ID (1-4094)');
            return;
        }
    } else {
        newVLAN = parseInt(vlanSelect);
    }
    
    const reason = document.getElementById('vlanChangeReason').value || 'VLAN changed via web interface';
    
    // Confirm the change
    if (!confirm(`Are you sure you want to change ${port} to VLAN ${newVLAN}?`)) {
        return;
    }
    
    // Show loading state
    const executeBtn = event.target;
    const originalText = executeBtn.innerHTML;
    executeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing...';
    executeBtn.disabled = true;
    
    // Send API request
    fetch('/api/ports/change-vlan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            port: port,
            vlan_id: newVLAN,
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        executeBtn.innerHTML = originalText;
        executeBtn.disabled = false;
        
        if (data.success) {
            changeVLANModal.hide();
            showMessage('success', `Port ${port} successfully moved to VLAN ${newVLAN}`);
            
            // Refresh ports after 1.5 seconds to show the change
            setTimeout(() => refreshPorts(true), 1500);
        } else {
            showMessage('danger', data.message || 'Failed to change VLAN');
        }
    })
    .catch(error => {
        console.error('VLAN change error:', error);
        executeBtn.innerHTML = originalText;
        executeBtn.disabled = false;
        showMessage('danger', 'Error: ' + error.message);
    });
}

function showMessage(type, message) {
    // Create alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => alertDiv.remove(), 5000);
}
</script>
{% endblock %}

